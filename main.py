"""
    ~~Credits~~
    made by physics1514_

    Other credits:
    External UI  -  birb.yay (eevee x ui)
    ppl on the ROBLOX devforum (accessing local host through roblox) and stack overflow (remove ssl certificate to stop some errors)
"""

import webview
import os
import time
import random
import subprocess
import socket
import re
from flask import Flask, request
from urllib.request import urlopen

app = Flask(__name__)

procName = "vylara"

def getappend(filename): # in general it should get get write lol
    return os.path.getmtime(filename)

script_filename = "script.txt"

if not os.path.exists(script_filename):
    print("Creating script file...")
    with open(script_filename, "x") as script:
        pass
    print("Done.")
else:
    print("Script file already exists.")

def checkPort(port):
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        return s.connect_ex(('localhost', port)) == 0


def localHost():
    port = random.randint(1000, 9999)
    while checkPort(port):
        print(f"Port {port} is already in use. Trying another port...")
        port = random.randint(1000, 9999)
        time.sleep(1)

    subprocess.Popen(["python3", "-m", "http.server", str(port)])
    print(f"Server started on port {port}")

localHost()
print("Running ui...")

def extractUrl(content):
    match = re.search(r'game:HttpGet\("([^"]+)"\)', content)
    if match:
        return match.group(1)
    return None
# found a string extractor on replit for this ^^


def execute(content):
    url = extractUrl(content)
    if url:
        print("Extracted url:", url)
        print("Getting data from url...")
        data = urlopen(url).read()
        print("Done. Encoding...")
        # i decoded it properly this time lol
        data_str = data.decode('utf-8')  # turns out it's utf-8 after all
        print("Got data. Writing...")
        writeFile = open("script.txt", "w")
        writeFile.write(data_str)
        writeFile.close()
    else:
        print("Writing script set to script.txt at local host 3000...")
        writeFile = open("script.txt", "w")
        writeFile.write(content)
        writeFile.close()

def closeWindow():
    window.destroy()

def minimizeWindow():
    window.minimize()

def setStatus(text): # birb stuff
    window.evaluate_js(f'document.getElementById("headerStatusLabel").textContent = "{text}"')

def main():
    global window
    new_process_name = "vylara"

    window = webview.create_window(
        new_process_name, 'index.html', width=722, height=337, frameless=True, on_top=True
    )

    window.expose(minimizeWindow, closeWindow, execute) # each function to carry over to the index.html, it can be used using the pyview api.
    webview.start()

if __name__ == "__main__":
    main()
